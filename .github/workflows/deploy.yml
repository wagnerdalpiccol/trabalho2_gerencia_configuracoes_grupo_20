name: Pipeline de Deploy Multi-Ambiente
run-name: Deploy em andamento para ${{ github.ref_name }} (Disparado por ${{ github.event_name }})

# --- GATILHOS (TRIGGERS) ---
on:
  # 1. master/main: Sempre que houver push ou PR merged
  push:
    branches:
      - main
      - master

  # 2. preprod: Agendado (diariamente Ã s 10:00 UTC)
  schedule:
    - cron: '0 10 * * *'

  # 3. preprod e dev: Disparo manual
  workflow_dispatch:
    inputs:
      target_environment:
        description: 'Selecione o ambiente para deploy manual (preprod ou dev)'
        required: true
        type: choice
        options:
          - preprod
          - dev

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: ðŸ” Definir VariÃ¡veis de Ambiente e Branch Alvo
        id: set_env
        run: |
          # Define o hostname do Supabase para correÃ§Ã£o de IPv4 (SEU HOSTNAME AQUI)
          echo "HOST_SUPABASE=db.furkyzfwvzptwtbkoacl.supabase.co" >> $GITHUB_ENV
          
          # 1. Triggers 'push' (master/main)
          if [[ "${{ github.event_name }}" == "push" && ("${{ github.ref_name }}" == "main" || "${{ github.ref_name }}" == "master") ]]; then
            echo "TARGET_ENV=prod" >> $GITHUB_ENV
            echo "DB_URL_SECRET=${{ secrets.PROD_DB_URL }}" >> $GITHUB_ENV # VariÃ¡vel do Secret (sem correÃ§Ã£o)
            echo "DEPLOY_HOOK=${{ secrets.PROD_DEPLOY_HOOK }}" >> $GITHUB_ENV
            echo "TARGET_BRANCH=main" >> $GITHUB_ENV

          # 2. Trigger 'schedule' (preprod)
          elif [[ "${{ github.event_name }}" == "schedule" ]]; then
            echo "TARGET_ENV=preprod" >> $GITHUB_ENV
            echo "DB_URL_SECRET=${{ secrets.PREPROD_DB_URL }}" >> $GITHUB_ENV
            echo "DEPLOY_HOOK=${{ secrets.PREPROD_DEPLOY_HOOK }}" >> $GITHUB_ENV
            echo "TARGET_BRANCH=preprod" >> $GITHUB_ENV

          # 3. Trigger 'workflow_dispatch' (manual - preprod ou dev)
          elif [[ "${{ github.event_name }}" == "workflow_dispatch" ]]; then
            ENV_CHOICE="${{ github.event.inputs.target_environment }}"
            echo "TARGET_ENV=$ENV_CHOICE" >> $GITHUB_ENV
            echo "TARGET_BRANCH=$ENV_CHOICE" >> $GITHUB_ENV
          
            if [[ "$ENV_CHOICE" == "preprod" ]]; then
              echo "DB_URL_SECRET=${{ secrets.PREPROD_DB_URL }}" >> $GITHUB_ENV
              echo "DEPLOY_HOOK=${{ secrets.PREPROD_DEPLOY_HOOK }}" >> $GITHUB_ENV
            elif [[ "$ENV_CHOICE" == "dev" ]]; then
              echo "DB_URL_SECRET=${{ secrets.DEV_DB_URL }}" >> $GITHUB_ENV
              echo "DEPLOY_HOOK=${{ secrets.DEV_DEPLOY_HOOK }}" >> $GITHUB_ENV
            fi
          
          # 4. Falha se nÃ£o for um trigger vÃ¡lido para deploy
          else
            echo "Skipping deploy..."
            exit 0
          fi

      - name: âš™ï¸ Checkout do CÃ³digo (Branch Alvo)
        uses: actions/checkout@v4
        with:
          ref: ${{ env.TARGET_BRANCH }}

      - name: ðŸ’¾ Instalar Ferramentas de BD e DNS
        run: |
          # Instala cliente PostgreSQL (psql) e ferramenta de DNS (dig)
          sudo apt-get update
          sudo apt-get install -y postgresql-client dnsutils

      - name: ðŸ”´ AUTO-CORREÃ‡ÃƒO: Resolver IPv4 e Substituir Host
        id: resolve_ip
        run: |
          # 1. Tenta resolver o IPv4 para o hostname do Supabase
          echo "Tentando resolver o IPv4 para $HOST_SUPABASE..."
          # Filtra a resposta do dig para obter APENAS o endereÃ§o IPv4 (Tipo A)
          IPV4_ADDRESS=$(dig +short A $HOST_SUPABASE | grep -E '^[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}$' | head -n 1)
          
          if [ -z "$IPV4_ADDRESS" ]; then
            echo "âŒ ERRO CRÃTICO: NÃ£o foi possÃ­vel resolver o IPv4. Falha na soluÃ§Ã£o automÃ¡tica."
            exit 1 # Falha o job se nÃ£o encontrar IPv4
          fi
          
          echo "âœ… IPv4 Resolvido: $IPV4_ADDRESS"
          
          # 2. Usa SED para substituir o hostname pelo IP Literal na URL do Secret
          CORRECTED_DB_URL=$(echo "$DB_URL_SECRET" | sed "s|$HOST_SUPABASE|$IPV4_ADDRESS|")
          
          echo "âœ… URL Corrigida gerada."
          echo "CORRECTED_DB_URL=$CORRECTED_DB_URL" >> $GITHUB_ENV # Salva a string FINAL para o prÃ³ximo passo

      - name: ðŸš€ Deploy do Frontend (PÃ¡gina HTML)
        # Dispara o Netlify Build Hook
        run: |
          echo "Disparando deploy do Frontend para o ambiente ${{ env.TARGET_ENV }}..."
          curl -X POST -d {} "${{ env.DEPLOY_HOOK }}"
          echo "Hook de Deploy enviado. Verifique o status no Netlify."

      - name: ðŸ”„ Executar MigraÃ§Ãµes do Banco de Dados
        run: |
          echo "Iniciando migraÃ§Ãµes para o BD ${{ env.TARGET_ENV }}..."
          
          # Usa a URL corrigida com o IP Literal para evitar problemas de IPv6/DNS
          psql "$CORRECTED_DB_URL" -f migrations/01_initial_setup.sql -v ON_ERROR_STOP=1
          
          echo "MigraÃ§Ãµes do banco de dados concluÃ­das com sucesso para o ambiente ${{ env.TARGET_ENV }}."