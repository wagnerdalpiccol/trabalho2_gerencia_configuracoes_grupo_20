name: Pipeline de Deploy Multi-Ambiente
run-name: Deploy em andamento para ${{ github.ref_name }} (Disparado por ${{ github.event_name }})

# --- GATILHOS (TRIGGERS) ---
on:
  push:
    branches:
      - main
      - master
  schedule:
    - cron: '0 10 * * *'
  workflow_dispatch:
    inputs:
      target_environment:
        description: 'Selecione o ambiente para deploy manual (preprod ou dev)'
        required: true
        type: choice
        options:
          - preprod
          - dev

# --- VARI√ÅVEIS DE AMBIENTE (Configuradas em Secrets) ---
# Use o hostname e a senha escapada nos Secrets!
jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: üîç Definir Vari√°veis de Ambiente e Branch Alvo
        id: set_env
        run: |
          # (L√≥gica de IF/ELIF/ELSE para definir TARGET_ENV, DB_URL e DEPLOY_HOOK - SEM ALTERA√á√ÉO)
          if [[ "${{ github.event_name }}" == "push" && ("${{ github.ref_name }}" == "main" || "${{ github.ref_name }}" == "master") ]]; then
            echo "TARGET_ENV=prod" >> $GITHUB_ENV
            echo "DB_URL_SECRET=${{ secrets.PROD_DB_URL }}" >> $GITHUB_ENV # NOME RENOMEADO
            echo "DEPLOY_HOOK=${{ secrets.PROD_DEPLOY_HOOK }}" >> $GITHUB_ENV
            echo "TARGET_BRANCH=main" >> $GITHUB_ENV
            echo "HOST_SUPABASE=db.furkyzfwvzptwtbkoacl.supabase.co" >> $GITHUB_ENV # Salva o hostname
          elif [[ "${{ github.event_name }}" == "schedule" ]]; then
            echo "TARGET_ENV=preprod" >> $GITHUB_ENV
            echo "DB_URL_SECRET=${{ secrets.PREPROD_DB_URL }}" >> $GITHUB_ENV
            echo "DEPLOY_HOOK=${{ secrets.PREPROD_DEPLOY_HOOK }}" >> $GITHUB_ENV
            echo "TARGET_BRANCH=preprod" >> $GITHUB_ENV
            echo "HOST_SUPABASE=db.furkyzfwvzptwtbkoacl.supabase.co" >> $GITHUB_ENV
          elif [[ "${{ github.event_name }}" == "workflow_dispatch" ]]; then
            ENV_CHOICE="${{ github.event.inputs.target_environment }}"
            echo "TARGET_ENV=$ENV_CHOICE" >> $GITHUB_ENV
            echo "TARGET_BRANCH=$ENV_CHOICE" >> $GITHUB_ENV
            echo "HOST_SUPABASE=db.furkyzfwvzptwtbkoacl.supabase.co" >> $GITHUB_ENV
          
            if [[ "$ENV_CHOICE" == "preprod" ]]; then
              echo "DB_URL_SECRET=${{ secrets.PREPROD_DB_URL }}" >> $GITHUB_ENV
              echo "DEPLOY_HOOK=${{ secrets.PREPROD_DEPLOY_HOOK }}" >> $GITHUB_ENV
            elif [[ "$ENV_CHOICE" == "dev" ]]; then
              echo "DB_URL_SECRET=${{ secrets.DEV_DB_URL }}" >> $GITHUB_ENV
              echo "DEPLOY_HOOK=${{ secrets.DEV_DEPLOY_HOOK }}" >> $GITHUB_ENV
            fi
          else
            echo "Skipping deploy..."
            exit 0
          fi

      - name: ‚öôÔ∏è Checkout do C√≥digo (Branch Alvo)
        uses: actions/checkout@v4
        with:
          ref: ${{ env.TARGET_BRANCH }}

      - name: üíæ Instalar Ferramentas de BD e DNS
        run: |
          sudo apt-get update
          sudo apt-get install -y postgresql-client dnsutils

      - name: üî¥ AUTO-CORRE√á√ÉO: Resolver IPv4 e Substituir Host
        id: resolve_ip
        run: |
          # 1. Tenta resolver o IPv4 para o hostname do Supabase
          echo "Tentando resolver o IPv4 para $HOST_SUPABASE..."
          # Filtra a resposta do dig para obter APENAS o endere√ßo IPv4 (Tipo A)
          IPV4_ADDRESS=$(dig +short A $HOST_SUPABASE | grep -E '^[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}$' | head -n 1)
          
          if [ -z "$IPV4_ADDRESS" ]; then
            echo "‚ùå ERRO CR√çTICO: N√£o foi poss√≠vel resolver o IPv4. Falha na solu√ß√£o autom√°tica."
            exit 1
          fi
          
          echo "‚úÖ IPv4 Resolvido: $IPV4_ADDRESS"
          
          # 2. Usa SED para substituir o hostname pela vari√°vel de IP Literal
          # O comando SED faz o trabalho de corrigir a string de conex√£o
          # Substitui 'db.furkyzfwvzptwtbkoacl.supabase.co' pelo IP resolvido
          CORRECTED_DB_URL=$(echo "$DB_URL_SECRET" | sed "s|$HOST_SUPABASE|$IPV4_ADDRESS|")
          
          echo "‚úÖ URL Corrigida gerada."
          echo "CORRECTED_DB_URL=$CORRECTED_DB_URL" >> $GITHUB_ENV # Salva a string FINAL para o pr√≥ximo passo

      - name: üöÄ Deploy do Frontend (P√°gina HTML)
        run: |
          echo "Disparando deploy do Frontend para o ambiente ${{ env.TARGET_ENV }}..."
          curl -X POST -d {} "${{ env.DEPLOY_HOOK }}"
          echo "Hook de Deploy enviado. Verifique o status no Netlify."

      - name: üîÑ Executar Migra√ß√µes do Banco de Dados
        run: |
          echo "Iniciando migra√ß√µes para o BD ${{ env.TARGET_ENV }}..."
          
          # A vari√°vel 'CORRECTED_DB_URL' cont√©m o IP literal e a senha escapada
          # N√£o usamos mais ${{ env.DB_URL_SECRET }}
          psql "$CORRECTED_DB_URL" -f migrations/01_initial_setup.sql -v ON_ERROR_STOP=1
          
          echo "Migra√ß√µes do banco de dados conclu√≠das com sucesso para o ambiente ${{ env.TARGET_ENV }}."
  ```eof
  
  ### A√ß√µes Finais para o Sucesso
  
  1.  **Copie este novo `deploy.yml`** e substitua o arquivo atual.
2.  **Verifique os Secrets:** Garanta que seus Secrets (`PROD_DB_URL`, etc.) contenham a URL original do Supabase com a **senha escapada**:
    * **`PROD_DB_URL`:** `postgresql://postgres:r%246T8%23fk97f2@db.furkyzfwvzptwtbkoacl.supabase.co:5432/postgres?sslmode=require`
  3.  Fa√ßa *commit* e *push* do novo `deploy.yml`.
  4.  V√° para a aba **Actions** e **Re-run jobs**.
  
  Se a resolu√ß√£o DNS do IPv4 for bem-sucedida dentro do ambiente do GitHub, a migra√ß√£o **DEVE** passar agora. Me diga o resultado!